/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.4.1
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Postmate=t()}(this,function(){"use strict";var e="application/x-postmate-v1+json",t=Object.prototype.hasOwnProperty,n=0,r=function(t,n){return t.origin===n&&("object"==typeof t.data&&("postmate"in t.data&&(t.data.type===e&&!!{"handshake-reply":1,call:1,emit:1,reply:1,request:1}[t.data.postmate])))},i=function(e,t){var n="function"==typeof e[t]?e[t]():e[t];return s.Promise.resolve(n)},a=function(){function t(e){var t=this;this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.events={},this.listener=function(e){var n=((e||{}).data||{}).value||{},r=n.data,i=n.name;"emit"===e.data.postmate&&i in t.events&&t.events[i].call(t,r)},this.parent.addEventListener("message",this.listener,!1)}var r=t.prototype;return r.get=function(t){var r=this;return new s.Promise(function(i){var a=++n;r.parent.addEventListener("message",function e(t){t.data.uid===a&&"reply"===t.data.postmate&&(r.parent.removeEventListener("message",e,!1),i(t.data.value))},!1),r.child.postMessage({postmate:"request",type:e,property:t,uid:a},r.childOrigin)})},r.call=function(t,n){this.child.postMessage({postmate:"call",type:e,property:t,data:n},this.childOrigin)},r.on=function(e,t){this.events[e]=t},r.destroy=function(){window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)},t}(),o=function(){function t(t){var n=this;this.model=t.model,this.parent=t.parent,this.parentOrigin=t.parentOrigin,this.child=t.child,this.child.addEventListener("message",function(t){if(r(t,n.parentOrigin)){var a=t.data,o=a.property,s=a.uid,d=a.data;"call"!==t.data.postmate?i(n.model,o).then(function(n){return t.source.postMessage({property:o,postmate:"reply",type:e,uid:s,value:n},t.origin)}):o in n.model&&"function"==typeof n.model[o]&&n.model[o].call(n,d)}})}return t.prototype.emit=function(t,n){this.parent.postMessage({postmate:"emit",type:e,value:{name:t,data:n}},this.parentOrigin)},t}(),s=function(){function t(e){var t=this,n=void 0===e?userOptions:e,r=n.container,i=void 0===r?void 0!==i?i:document.body:r,a=n.model,o=n.url;return this.parent=window,this.model=a||{},this.bodyReady().then(function(){return t.createIframe()}).then(function(e){i.appendChild(e),t.frame=e,t.child=e.contentWindow||e.contentDocument.parentWindow}).then(function(){return t.sendHandshake(o)})}var n=t.prototype;return n.bodyReady=function(){return new t.Promise(function(e){if(document&&document.body)return e(document.body);var t=setInterval(function(){if(document&&document.body)return clearInterval(t),e(document.body)},10)})},n.createIframe=function(){var e=document.createElement("iframe");return e.setAttribute("style","display: none; margin: 0; padding: 0; border: 0px none; overflow: hidden;"),e.setAttribute("frameborder","0"),e.setAttribute("border","0"),e.setAttribute("scrolling","no"),e.setAttribute("allowTransparency","true"),e.setAttribute("tabindex","-1"),e.setAttribute("hidden","true"),e.setAttribute("title",""),e.setAttribute("role","presentation"),e},n.sendHandshake=function(n){var i,o=this,s=function(e){var t=document.createElement("a");t.href=e;var n=t.protocol.length>4?t.protocol:window.location.protocol,r=t.host.length?"80"===t.port||"443"===t.port?t.hostname:t.host:window.location.host;return t.origin||n+"//"+r}(n),d=0;return new t.Promise(function(t,u){o.parent.addEventListener("message",function e(n){return!!r(n,s)&&("handshake-reply"===n.data.postmate?(clearInterval(i),o.parent.removeEventListener("message",e,!1),o.childOrigin=n.origin,t(new a(o))):u("Failed handshake"))},!1);var c=function(){d++,o.child.postMessage({postmate:"handshake",type:e,model:o.model},s),5===d&&clearInterval(i)},l=function(){c(),i=setInterval(c,500)};o.frame.attachEvent?o.frame.attachEvent("onload",l):o.frame.onload=l,o.frame.src=n})},t}();return s.debug=!1,s.Promise=function(){try{return window?window.Promise:Promise}catch(e){return null}}(),s.Model=function(){function n(e){return this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return n.prototype.sendHandshakeReply=function(){var n=this;return new s.Promise(function(r,i){n.child.addEventListener("message",function a(s){if(s.data.postmate){if("handshake"===s.data.postmate){n.child.removeEventListener("message",a,!1),s.source.postMessage({postmate:"handshake-reply",type:e},s.origin),n.parentOrigin=s.origin;var d=s.data.model;if(d)for(var u=Object.keys(d),c=0;c<u.length;c++)t.call(d,u[c])&&(n.model[u[c]]=d[u[c]]);return r(new o(n))}return i("Handshake Reply Failed")}},!1)})},n}(),s});
