/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.4.7
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Postmate=t()}(this,function(){"use strict";var l="undefined"!=typeof MessageChannel,u="application/x-postmate-v1+json",a=0,n={handshake:1,"handshake-reply":1,call:1,emit:1,reply:1,request:1},p=function(e,t){return!(!l&&"string"==typeof t&&e.origin!==t)&&("object"==typeof e.data&&("postmate"in e.data&&(e.data.type===u&&!!n[e.data.postmate])))},c=function(e,t,n){e.postMessage(t,l?void 0:n)},m=function(){function e(e){var r=this;this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.source=e.source,this.target=e.target,this.events={},this.listener=function(e){if(p(e,r.childOrigin)&&"emit"===e.data.postmate){var t=e.data.value,n=t.data,i=t.name;i in r.events&&r.events[i].call(r,n)}},this.addMessageListener(this.listener)}var t=e.prototype;return t.addMessageListener=function(e){this.source.addEventListener("message",e,!1)},t.removeMessageListener=function(e){this.source.removeEventListener("message",e,!1)},t.get=function(e){var r=this;return new v.Promise(function(n){var i=++a;r.addMessageListener(function e(t){p(t,r.childOrigin)&&t.data.uid===i&&"reply"===t.data.postmate&&(r.removeMessageListener(e),n(t.data.value))}),c(r.target,{postmate:"request",type:u,property:e,uid:i},r.childOrigin)})},t.call=function(e,t){c(this.target,{postmate:"call",type:u,property:e,data:t},this.childOrigin)},t.on=function(e,t){this.events[e]=t},t.destroy=function(){this.removeMessageListener(this.listener),this.frame.parentNode.removeChild(this.frame)},e}(),f=function(){function e(e){var d=this;this.model=e.model,this.parent=e.parent,this.parentOrigin=e.parentOrigin,this.child=e.child,this.source=e.source,this.target=e.target,this.source.addEventListener("message",function(e){if(p(e,d.parentOrigin)){var t,n,i,r=e.data,a=r.property,o=r.uid,s=r.data;if("call"!==e.data.postmate)(t=d.model,n=a,i="function"==typeof t[n]?t[n]():t[n],v.Promise.resolve(i)).then(function(e){return c(d.target,{property:a,postmate:"reply",type:u,uid:o,value:e},d.parentOrigin)});else a in d.model&&"function"==typeof d.model[a]&&d.model[a].call(d,s)}})}return e.prototype.emit=function(e,t){c(this.target,{postmate:"emit",type:u,value:{name:e,data:t}},this.parentOrigin)},e}(),v=function(){function e(e){var t=e.container,n=void 0===t?void 0!==n?n:document.body:t,i=e.model,r=e.url;return this.parent=window,this.frame=document.createElement("iframe"),n.appendChild(this.frame),this.child=this.frame.contentWindow||this.frame.contentDocument.parentWindow,this.model=i||{},this.sendHandshake(r)}return e.prototype.sendHandshake=function(n){var o,s,d=this,c=function(e){var t=document.createElement("a");t.href=e;var n=4<t.protocol.length?t.protocol:window.location.protocol,i=t.host.length?"80"===t.port||"443"===t.port?t.hostname:t.host:window.location.host;return t.origin||n+"//"+i}(n),h=0;return new e.Promise(function(r,a){var i=function(t,n){void 0===n&&(n=t);var e=function(e){if(p(e,c))return d.source=t,d.target=n,"handshake-reply"===e.data.postmate?(clearInterval(o),i(),d.childOrigin=e.origin,r(new m(d))):a("Failed handshake")};t.addEventListener("message",e,!1);var i=function(){t.removeEventListener("message",e,!1)};return i},e=function(){if(5!==h){var e,t;if(h++,s&&s(),l){var n=new MessageChannel;e=n.port1,t=n.port2,s=i(e),e.start()}else s=i(d.parent,d.child);d.child.postMessage({postmate:"handshake",type:u,model:d.model},c,t?[t]:[])}else clearInterval(o)},t=function(){e(),o=setInterval(e,500)};d.frame.attachEvent?d.frame.attachEvent("onload",t):d.frame.onload=t,d.frame.src=n})},e}();return v.Promise=function(){try{return window?window.Promise:Promise}catch(e){return function(){var e;return v.debug?(e=console).log.apply(e,arguments):null}("Promise: error",e)}}(),v.Model=function(){function e(e){return this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return e.prototype.sendHandshakeReply=function(){var h=this;return new v.Promise(function(d,c){h.child.addEventListener("message",function e(t){if(p(t,!1)){if("handshake"!==t.data.postmate)return c("Handshake Reply Failed");h.child.removeEventListener("message",e,!1);var n=t.source,i=t.ports,r=t.origin,a={postmate:"handshake-reply",type:u};if(i){var o=i[0];h.source=o,(h.target=o).postMessage(a),o.start()}else h.source=h.child,h.target=h.parent,n.postMessage(a,r);h.parentOrigin=r;var s=t.data.model;return s&&Object.keys(s).forEach(function(e){h.model[e]=s[e]}),d(new f(h))}},!1)})},e}(),v});
