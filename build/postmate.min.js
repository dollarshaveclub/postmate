/**
  postmate - A powerful, simple, promise-based postMessage library
  @version v1.4.1
  @link https://github.com/dollarshaveclub/postmate
  @author Jacob Kelley <jakie8@gmail.com>
  @license MIT
**/
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.Postmate=t()}(this,function(){"use strict";var e="application/x-postmate-v1+json",t=Object.prototype.hasOwnProperty,n=0,i=function(t,n){return t.origin===n&&("object"==typeof t.data&&("postmate"in t.data&&(t.data.type===e&&!!{"handshake-reply":1,call:1,emit:1,reply:1,request:1}[t.data.postmate])))},r=function(e,t){var n="function"==typeof e[t]?e[t]():e[t];return d.Promise.resolve(n)},o=function(e){return new d.Promise(function(t,n){var i=document.createElement("iframe");i.onload=function(){t(i)},i.setAttribute("style","display: none; visibility: hidden;"),i.setAttribute("width","0"),i.setAttribute("height","0"),e.appendChild(i)})},a=function(){function t(e){var t=this;this.parent=e.parent,this.frame=e.frame,this.child=e.child,this.childOrigin=e.childOrigin,this.events={},this.listener=function(n){var r=((n||{}).data||{}).value||{},o=r.data,a=r.name;i(n,e.childOrigin)&&"emit"===n.data.postmate&&a in t.events&&t.events[a].call(t,o)},this.parent.addEventListener("message",this.listener,!1)}var r=t.prototype;return r.get=function(t){var i=this;return new d.Promise(function(r){var o=++n;i.parent.addEventListener("message",function e(t){t.data.uid===o&&"reply"===t.data.postmate&&(i.parent.removeEventListener("message",e,!1),r(t.data.value))},!1),i.child.postMessage({postmate:"request",type:e,property:t,uid:o},i.childOrigin)})},r.call=function(t,n){this.child.postMessage({postmate:"call",type:e,property:t,data:n},this.childOrigin)},r.on=function(e,t){this.events[e]=t},r.destroy=function(){window.removeEventListener("message",this.listener,!1),this.frame.parentNode.removeChild(this.frame)},t}(),s=function(){function t(t){var n=this;this.model=t.model,this.parent=t.parent,this.parentOrigin=t.parentOrigin,this.child=t.child,this.child.addEventListener("message",function(t){if(i(t,n.parentOrigin)){var o=t.data,a=o.property,s=o.uid,d=o.data;"call"!==t.data.postmate?r(n.model,a).then(function(n){return t.source.postMessage({property:a,postmate:"reply",type:e,uid:s,value:n},t.origin)}):a in n.model&&"function"==typeof n.model[a]&&n.model[a].call(n,d)}})}return t.prototype.emit=function(t,n){this.parent.postMessage({postmate:"emit",type:e,value:{name:t,data:n}},this.parentOrigin)},t}(),d=function(){function t(e){var t=this,n=void 0===e?userOptions:e,i=n.model,r=n.url;return this.parent=window,this.model=i||{},this.bodyReady().then(function(e){return o(e)}).then(function(e){t.frame=e}).then(function(){return t.sendHandshake(r)})}var n=t.prototype;return n.bodyReady=function(){return new t.Promise(function(e){if(document&&document.body)return e(document.body);var t=setInterval(function(){if(document&&document.body)return clearInterval(t),e(document.body)},10)})},n.sendHandshake=function(n){var r,o=this,s=function(e){var t=document.createElement("a");t.href=e;var n=t.protocol.length>4?t.protocol:window.location.protocol,i=t.host.length?"80"===t.port||"443"===t.port?t.hostname:t.host:window.location.host;return t.origin||n+"//"+i}(n),d=0;return new t.Promise(function(t,c){o.parent.addEventListener("message",function e(n){return!!i(n,s)&&("handshake-reply"===n.data.postmate?(clearInterval(r),o.parent.removeEventListener("message",e,!1),o.childOrigin=n.origin,t(new a(o))):c("Failed handshake"))},!1);var u=function(){d++,o.child.postMessage({postmate:"handshake",type:e,model:o.model},s),5===d&&clearInterval(r)},l=function(){o.child=function(e){if(!e.contentWindow)throw e.contentDocument&&e.contentDocument.parentWindow?new Error("iframe.contentWindow is null after onload for: "+e.src+", but got parentWindow!"):new Error("iframe.contentWindow is null after onload for: "+e.src);return e.contentWindow}(o.frame),u(),r=setInterval(u,500)};o.frame.attachEvent?o.frame.attachEvent("onload",l):o.frame.onload=l,o.frame.src=n})},t}();return d.debug=!1,d.Promise=function(){try{return window?window.Promise:Promise}catch(e){return null}}(),d.Model=function(){function n(e){return this.child=window,this.model=e,this.parent=this.child.parent,this.sendHandshakeReply()}return n.prototype.sendHandshakeReply=function(){var n=this;return new d.Promise(function(i,r){n.child.addEventListener("message",function o(a){if(a.data.postmate){if("handshake"===a.data.postmate){n.child.removeEventListener("message",o,!1),a.source.postMessage({postmate:"handshake-reply",type:e},a.origin),n.parentOrigin=a.origin;var d=a.data.model;if(d)for(var c=Object.keys(d),u=0;u<c.length;u++)t.call(d,c[u])&&(n.model[c[u]]=d[c[u]]);return i(new s(n))}return r("Handshake Reply Failed")}},!1)})},n}(),d});
